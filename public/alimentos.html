<!-- Añade este input arriba del botón "Añadir Alimento" -->
<label for="search-food">Buscar alimento en base de datos pública</label>
<input type="text" id="search-food" placeholder="Escribe para buscar alimentos..." autocomplete="off" />

<div id="search-results" class="search-results"></div>

<button id="btn-add-alimento">➕ Añadir Alimento Manualmente</button>

<!-- Caja tabla alimentos añadidos -->
<section id="alimentos-agregados" aria-label="Alimentos añadidos" style="max-width:700px; margin-top: 2rem; font-family: 'Poppins', sans-serif; color:#27ae60; background:#e6f2ea; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 4px 8px rgba(39,174,96,0.1);">
  <h2 style="font-weight:600; margin-bottom:1rem;">Alimentos Añadidos</h2>
  <table style="width:100%; border-collapse: collapse;">
    <thead>
      <tr style="background-color:#27ae60; color:#fff; font-weight:600;">
        <th style="padding:0.7rem 1rem; text-align:left;">Alimento</th>
        <th style="padding:0.7rem 1rem; text-align:left;">Cantidad (g)</th>
        <th style="padding:0.7rem 1rem; text-align:left;">Calorías (kcal)</th>
      </tr>
    </thead>
    <tbody id="alimentos-table-body">
      <!-- Se llenará dinámicamente -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="text-align:right; font-weight:600; padding:0.7rem 1rem;">Total Calorías:</td>
        <td id="total-calorias" style="padding:0.7rem 1rem; font-weight:700; color:#145214;">0</td>
      </tr>
    </tfoot>
  </table>
</section>

<script>
  const searchFoodInput = document.getElementById('search-food');
  const searchResultsDiv = document.getElementById('search-results');
  const alimentosTableBody = document.getElementById('alimentos-table-body');
  const totalCaloriasCell = document.getElementById('total-calorias');

  let alimentosAgregados = [];
  let resultadosBusquedaActuales = [];

  async function buscarAlimentos(query) {
    if (!query || query.length < 3) {
      searchResultsDiv.innerHTML = '';
      resultadosBusquedaActuales = [];
      return;
    }

    try {
      const res = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=10`);
      if (!res.ok) throw new Error('Error al buscar alimentos');
      const data = await res.json();

      resultadosBusquedaActuales = data.products || [];
      mostrarResultadosBusqueda(resultadosBusquedaActuales);
    } catch (error) {
      console.error(error);
      searchResultsDiv.innerHTML = '<p>Error al buscar alimentos</p>';
      resultadosBusquedaActuales = [];
    }
  }

  function mostrarResultadosBusqueda(alimentos) {
    if (alimentos.length === 0) {
      searchResultsDiv.innerHTML = '<p>No se encontraron alimentos</p>';
      return;
    }

    searchResultsDiv.innerHTML = alimentos.map(alimento => {
      const nombre = alimento.product_name || alimento.generic_name || 'Sin nombre';
      const calorias = alimento.nutriments?.energy_kcal_100g || 'N/D';
      const proteinas = alimento.nutriments?.proteins_100g || 0;
      const grasas = alimento.nutriments?.fat_100g || 0;
      const carbohidratos = alimento.nutriments?.carbohydrates_100g || 0;

      return `
        <div class="search-result-item" tabindex="0" role="button" aria-label="Agregar alimento ${nombre}">
          <strong>${nombre}</strong><br />
          Calorías: ${calorias} kcal por 100g<br />
          Proteínas: ${proteinas} g, Grasas: ${grasas} g, Carbohidratos: ${carbohidratos} g
        </div>
      `;
    }).join('');

    // Añadimos event listeners a cada resultado (usando closure index)
    Array.from(searchResultsDiv.children).forEach((item, index) => {
      item.addEventListener('click', () => {
        const seleccionado = resultadosBusquedaActuales[index];
        agregarAlimentoSeleccionado(seleccionado);
      });
      item.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const seleccionado = resultadosBusquedaActuales[index];
          agregarAlimentoSeleccionado(seleccionado);
        }
      });
    });
  }

  function agregarAlimentoSeleccionado(alimento) {
    if (!alimento) return;
    const nombre = alimento.product_name || alimento.generic_name || 'Sin nombre';
    const caloriasPor100g = alimento.nutriments?.energy_kcal_100g || 0;

    let cantidad = prompt(`¿Cuántos gramos de "${nombre}" quieres agregar?`, "100");
    if (!cantidad) return;
    cantidad = parseFloat(cantidad);
    if (isNaN(cantidad) || cantidad <= 0) {
      alert("Por favor ingresa una cantidad válida en gramos.");
      return;
    }

    const caloriasTotales = (caloriasPor100g * cantidad) / 100;

    alimentosAgregados.push({
      nombre,
      cantidad,
      calorias: caloriasTotales
    });

    actualizarTablaAlimentos();

    // Limpiamos búsqueda para mejor UX
    searchFoodInput.value = '';
    searchResultsDiv.innerHTML = '';
  }

  function actualizarTablaAlimentos() {
    alimentosTableBody.innerHTML = alimentosAgregados.map(({ nombre, cantidad, calorias }) => `
      <tr>
        <td style="padding:0.7rem 1rem;">${nombre}</td>
        <td style="padding:0.7rem 1rem;">${cantidad.toFixed(1)} g</td>
        <td style="padding:0.7rem 1rem;">${calorias.toFixed(1)}</td>
      </tr>
    `).join('');

    const total = alimentosAgregados.reduce((acc, a) => acc + a.calorias, 0);
    totalCaloriasCell.textContent = total.toFixed(1);
  }

  let searchTimeout = null;
  searchFoodInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      buscarAlimentos(searchFoodInput.value.trim());
    }, 500);
  });
</script>

<style>
  .search-results {
    border: 1px solid #ccc;
    max-height: 300px;
    overflow-y: auto;
    margin: 5px 0 15px 0;
    background: #f9f9f9;
  }
  .search-result-item {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #ddd;
    color: #27ae60;
    font-family: 'Poppins', sans-serif;
  }
  .search-result-item:hover,
  .search-result-item:focus {
    background-color: #d4efdf;
    outline: none;
  }
</style>
