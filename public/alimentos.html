<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alimentos - Nutriox</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <main class="container">
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="dietas.html">Dietas</a>
      <a href="recetas.html">Recetas</a>
      <a href="alimentos.html" style="font-weight:700; color:#1366d6;">Alimentos</a>
      <a href="profile.html">Perfil</a>
      <a href="/" class="btn btn-danger">Cerrar sesi√≥n</a>
    </nav>

    <h1>Gestiona tus Alimentos</h1>
    <button id="btn-add-alimento">‚ûï A√±adir Alimento</button>

    <div id="message" class="message"></div>

    <div id="alimentos-list" class="alimentos-list">
      <!-- Aqu√≠ se mostrar√°n los alimentos -->
    </div>

    <!-- Modal para formulario -->
    <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal-content" role="document">
        <h2 id="modal-title">Nuevo Alimento</h2>

        <form id="alimento-form">
          <label for="nombre">Nombre</label>
          <input type="text" id="nombre" name="nombre" placeholder="Nombre del alimento" required />

          <label for="calorias">Calor√≠as (por porci√≥n)</label>
          <input type="number" id="calorias" name="calorias" placeholder="Calor√≠as" required min="0" />

          <label for="proteinas">Prote√≠nas (g)</label>
          <input type="number" id="proteinas" name="proteinas" placeholder="Prote√≠nas" min="0" step="0.1" />

          <label for="grasas">Grasas (g)</label>
          <input type="number" id="grasas" name="grasas" placeholder="Grasas" min="0" step="0.1" />

          <label for="carbohidratos">Carbohidratos (g)</label>
          <input type="number" id="carbohidratos" name="carbohidratos" placeholder="Carbohidratos" min="0" step="0.1" />

          <div class="modal-buttons">
            <button type="button" class="btn btn-cancel" id="btn-cancel">Cancelar</button>
            <button type="submit" class="btn btn-save">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    const alimentosList = document.getElementById('alimentos-list');
    const btnAddAlimento = document.getElementById('btn-add-alimento');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const alimentoForm = document.getElementById('alimento-form');
    const btnCancel = document.getElementById('btn-cancel');
    const messageEl = document.getElementById('message');

    let editingAlimentoId = null;

    // Cambia este ID por el ID real del usuario autenticado
    const usuarioId = 'TU_USUARIO_ID_AQUI';

    function showMessage(msg, type = 'success') {
      messageEl.textContent = msg;
      messageEl.className = 'message ' + type;
      setTimeout(() => {
        messageEl.textContent = '';
        messageEl.className = 'message';
      }, 4000);
    }

    function openModal(edit = false, alimento = null) {
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
      if (edit && alimento) {
        modalTitle.textContent = 'Editar Alimento';
        alimentoForm.nombre.value = alimento.nombre;
        alimentoForm.calorias.value = alimento.calorias;
        alimentoForm.proteinas.value = alimento.proteinas || '';
        alimentoForm.grasas.value = alimento.grasas || '';
        alimentoForm.carbohidratos.value = alimento.carbohidratos || '';
        editingAlimentoId = alimento._id;
      } else {
        modalTitle.textContent = 'Nuevo Alimento';
        alimentoForm.reset();
        editingAlimentoId = null;
      }
    }

    function closeModal() {
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      alimentoForm.reset();
      editingAlimentoId = null;
    }

    async function loadAlimentos() {
      try {
        const res = await fetch(`/api/alimentos/${usuarioId}`);
        if (!res.ok) throw new Error('Error al cargar alimentos');
        const alimentos = await res.json();
        renderAlimentos(alimentos);
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    function renderAlimentos(alimentos) {
      alimentosList.innerHTML = '';
      if (alimentos.length === 0) {
        alimentosList.innerHTML = '<p>No tienes alimentos a√±adidos a√∫n.</p>';
        return;
      }
      alimentos.forEach(alimento => {
        const card = document.createElement('div');
        card.className = 'alimento-card';
        card.innerHTML = `
          <h3>${alimento.nombre}</h3>
          <p>Calor√≠as: ${alimento.calorias}</p>
          <p>Prote√≠nas: ${alimento.proteinas || 0} g</p>
          <p>Grasas: ${alimento.grasas || 0} g</p>
          <p>Carbohidratos: ${alimento.carbohidratos || 0} g</p>
          <div class="actions">
            <button class="btn-edit" aria-label="Editar alimento ${alimento.nombre}">‚úèÔ∏è Editar</button>
            <button class="btn-delete" aria-label="Eliminar alimento ${alimento.nombre}">üóëÔ∏è Eliminar</button>
          </div>
        `;

        card.querySelector('.btn-edit').addEventListener('click', () => {
          openModal(true, alimento);
        });

        card.querySelector('.btn-delete').addEventListener('click', async () => {
          if (confirm(`¬øSeguro que quieres eliminar el alimento "${alimento.nombre}"?`)) {
            try {
              const res = await fetch(`/api/alimentos/${alimento._id}`, {
                method: 'DELETE',
              });
              if (!res.ok) throw new Error('Error al eliminar');
              showMessage('Alimento eliminado');
              loadAlimentos();
            } catch (error) {
              showMessage(error.message, 'error');
            }
          }
        });

        alimentosList.appendChild(card);
      });
    }

    alimentoForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        nombre: alimentoForm.nombre.value.trim(),
        calorias: Number(alimentoForm.calorias.value),
        proteinas: Number(alimentoForm.proteinas.value) || 0,
        grasas: Number(alimentoForm.grasas.value) || 0,
        carbohidratos: Number(alimentoForm.carbohidratos.value) || 0,
        usuario: usuarioId,
      };

      try {
        let res;
        if (editingAlimentoId) {
          res = await fetch(`/api/alimentos/${editingAlimentoId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        } else {
          res = await fetch(`/api/alimentos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        }
        if (!res.ok) throw new Error('Error al guardar alimento');
        showMessage(editingAlimentoId ? 'Alimento actualizado' : 'Alimento creado');
        closeModal();
        loadAlimentos();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    });

    btnAddAlimento.addEventListener('click', () => openModal());
    btnCancel.addEventListener('click', closeModal);

    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal();
    });

    window.addEventListener('DOMContentLoaded', loadAlimentos);
  </script>
</body>
</html>
